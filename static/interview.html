<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì¸í„°ë·° ì½”ì¹­ ë´‡</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 24px auto;
            padding: 0 16px 32px;
            line-height: 1.5;
        }
        h1 {
            margin-bottom: 8px;
        }
        textarea {
            width: 100%;
            min-height: 80px;
        }
        .section {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #ddd;
        }
        .label {
            font-weight: 600;
        }
        #feedback, #recognizedAnswer, #finalSummary, #questionText {
            white-space: pre-wrap;
            background: #f8f8f8;
            padding: 8px;
            border-radius: 4px;
            margin-top: 4px;
        }
        button {
            padding: 8px 14px;
            margin-top: 8px;
            cursor: pointer;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .small {
            font-size: 12px;
            color: #666;
        }

        #finalSummary {
            background: #fdfdfd;
            padding: 16px 18px;
            border-radius: 10px;
            border: 1px solid #e3e3e3;
            max-height: 320px;
            overflow-y: auto;
            margin-top: 8px;

            font-size: 14px;
            line-height: 1.6;
            color: #222;
        }

        #finalSummary h1,
        #finalSummary h2,
        #finalSummary h3 {
            margin: 12px 0 6px;
            line-height: 1.4;
            font-weight: 700;
        }

        #finalSummary h1 {
            font-size: 20px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 4px;
        }

        #finalSummary h2 {
            font-size: 17px;
        }

        #finalSummary h3 {
            font-size: 15px;
            color: #333;
        }

        #finalSummary ul {
            margin: 4px 0 10px 18px;
            padding-left: 0;
        }

        #finalSummary li {
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <h1>ì¸í„°ë·° ì½”ì¹­ ë´‡</h1>
    <p class="small">
        1) ì´ë ¥ì„œ / JDë¥¼ ì…ë ¥í•˜ê³  ì„¸ì…˜ì„ ì‹œì‘í•˜ì„¸ìš”.<br>
        2) ì§ˆë¬¸ì´ ìë™ìœ¼ë¡œ ì¬ìƒë©ë‹ˆë‹¤.<br>
        3) "ë‹µë³€ ë…¹ìŒ ì‹œì‘" â†’ "ë…¹ìŒ ì¢…ë£Œ & ì „ì†¡" ë²„íŠ¼ìœ¼ë¡œ ìŒì„± ë‹µë³€ì„ ë³´ë‚´ë©´<br>
        &nbsp;&nbsp;&nbsp;ë‹µë³€ì— ëŒ€í•œ ìš”ì•½ëœ í”¼ë“œë°±ì„ ë³´ì—¬ì£¼ë©° ë‹¤ìŒ ì§ˆë¬¸ì´ ì¬ìƒë©ë‹ˆë‹¤.<br>
        4) ì¸í„°ë·° ì¢…ë£Œì‹œ ì¢…í•©ì ì¸ í”¼ë“œë°±ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>

    <!-- 1. ì„¸ì…˜ ì„¤ì • -->
    <div class="section">
        <div class="label">ì´ë ¥ì„œ í…ìŠ¤íŠ¸</div>
        <textarea id="resumeText">ì—¬ê¸°ì— ì´ë ¥ì„œ í…ìŠ¤íŠ¸ë¥¼ ë„£ìœ¼ì„¸ìš”.</textarea>

        <div class="label" style="margin-top: 12px;">JD (ê³µê³  í…ìŠ¤íŠ¸)</div>
        <textarea id="jdText">ì—¬ê¸°ì— JD í…ìŠ¤íŠ¸ë¥¼ ë„£ìœ¼ì„¸ìš”.</textarea>

        <div class="label" style="margin-top: 12px;">ì»¤ë¦¬ì–´ ë…¸íŠ¸ (ì„ íƒ)</div>
        <textarea id="careerNote" placeholder="ì„ íƒì‚¬í•­"></textarea>

        <button id="startBtn" onclick="startSession()">ì„¸ì…˜ ì‹œì‘</button>
    </div>

    <!-- 2. ì§ˆë¬¸ / TTS ì¬ìƒ -->
    <div class="section">
        <div class="label">í˜„ì¬ ì§ˆë¬¸</div>
        <div id="questionText">-</div>

        <audio id="questionAudio" controls autoplay style="margin-top: 8px; width: 100%;"></audio>
    </div>

    <!-- 3. ë‹µë³€ ë…¹ìŒ / STT / í”¼ë“œë°± -->
    <div class="section">
        <div class="label">ë‹µë³€ ë…¹ìŒ</div>
        <button id="recordBtn" onclick="toggleRecording()" disabled>ë‹µë³€ ë…¹ìŒ ì‹œì‘</button>
        <div class="small">
            * ì²« ë²ˆì§¸ í´ë¦­: ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ í›„ ë…¹ìŒ ì‹œì‘<br>
            * ë‘ ë²ˆì§¸ í´ë¦­: ë…¹ìŒ ì¢…ë£Œ & ì„œë²„ë¡œ ì „ì†¡
        </div>

        <div class="label" style="margin-top: 12px;">ì¸ì‹ëœ í…ìŠ¤íŠ¸</div>
        <div id="recognizedAnswer">-</div>

        <div class="label" style="margin-top: 12px;">í”¼ë“œë°±</div>
        <div id="feedback">-</div>
    </div>

    <!-- 4. ìµœì¢… ìš”ì•½ -->
    <div class="section">
        <div class="label">ì¸í„°ë·° ì¢…í•© í”¼ë“œë°±</div>
        <div id="finalSummary">-</div>
    </div>

    <script>
        let sessionId = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        async function startSession() {
            const resumeText = document.getElementById("resumeText").value;
            const jdText = document.getElementById("jdText").value;
            const careerNote = document.getElementById("careerNote").value || null;

            const startBtn = document.getElementById("startBtn");
            startBtn.disabled = true;
            startBtn.textContent = "ì„¸ì…˜ ìƒì„± ì¤‘...";

            try {
                const res = await fetch("/api/v1/interview/session/init", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        resume_text: resumeText,
                        job_description: jdText,
                        career_note: careerNote,
                        mode: "mock"
                    })
                });

                if (!res.ok) {
                    const text = await res.text();
                    alert("ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: " + text);
                    startBtn.disabled = false;
                    startBtn.textContent = "ì„¸ì…˜ ì‹œì‘";
                    return;
                }

                const data = await res.json();

                sessionId = data.session_id;
                document.getElementById("questionText").textContent = data.question;

                // ì²« ì§ˆë¬¸ TTS ìë™ ì¬ìƒ
                playTTS(data.question);

                // ë…¹ìŒ ë²„íŠ¼ í™œì„±í™”
                document.getElementById("recordBtn").disabled = false;
                document.getElementById("recordBtn").textContent = "ë‹µë³€ ë…¹ìŒ ì‹œì‘";
                document.getElementById("feedback").textContent = "-";
                document.getElementById("recognizedAnswer").textContent = "-";
                document.getElementById("finalSummary").textContent = "-";

            } catch (e) {
                console.error(e);
                alert("ì„¸ì…˜ ìƒì„± ì¤‘ ì˜¤ë¥˜: " + e);
                startBtn.disabled = false;
                startBtn.textContent = "ì„¸ì…˜ ì‹œì‘";
            }
        }

        function playTTS(text) {
            if (!text) return;
            const audio = document.getElementById("questionAudio");
            const url = "/tts/stream?text=" + encodeURIComponent(text);
            audio.src = url;
            audio.play().catch(err => {
                console.warn("ìë™ ì¬ìƒ ì‹¤íŒ¨ (ë¸Œë¼ìš°ì € ì •ì±…ì¼ ìˆ˜ ìˆìŒ):", err);
            });
        }

        async function toggleRecording() {
            if (!sessionId) {
                alert("ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì„¸ì…˜ì„ ì‹œì‘í•˜ì„¸ìš”.");
                return;
            }

            const btn = document.getElementById("recordBtn");

            if (!isRecording) {
                // ğŸ”¹ ë…¹ìŒ ì‹œì‘
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = async () => {
                        const blob = new Blob(audioChunks, { type: "audio/webm" });
                        await sendAnswerAudio(blob);
                        // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    btn.textContent = "ë…¹ìŒ ì¢…ë£Œ & ì „ì†¡";

                } catch (e) {
                    console.error("ë§ˆì´í¬ ê¶Œí•œ ì˜¤ë¥˜:", e);
                    alert("ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì•¼ ë…¹ìŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                }
            } else {
                // ğŸ”¹ ë…¹ìŒ ì¤‘ì§€ â†’ onstopì—ì„œ ì„œë²„ ì „ì†¡
                mediaRecorder.stop();
                isRecording = false;
                btn.textContent = "ë‹µë³€ ì „ì†¡ ì¤‘...";
                btn.disabled = true;
            }
        }

        async function sendAnswerAudio(blob) {
            if (!sessionId) return;

            try {
                const fd = new FormData();
                fd.append("session_id", sessionId);
                fd.append("audio_file", blob, "answer.webm");  // ë°±ì—”ë“œì—ì„œ ffmpegë¡œ ì²˜ë¦¬ ê°€ëŠ¥í•´ì•¼ í•¨

                const res = await fetch("/api/v1/interview/session/answer/audio", {
                    method: "POST",
                    body: fd
                });

                const btn = document.getElementById("recordBtn");

                if (!res.ok) {
                    const text = await res.text();
                    alert("ë‹µë³€ ì „ì†¡ ì‹¤íŒ¨: " + text);
                    btn.textContent = "ë‹µë³€ ë…¹ìŒ ì‹œì‘";
                    btn.disabled = false;
                    return;
                }

                const data = await res.json();

                // STT ê²°ê³¼ / í”¼ë“œë°± í‘œì‹œ
                document.getElementById("recognizedAnswer").textContent =
                    data.recognized_answer || "(ì¸ì‹ ê²°ê³¼ ì—†ìŒ)";
                document.getElementById("feedback").textContent =
                    data.feedback || "(í”¼ë“œë°± ì—†ìŒ)";

                if (data.finished) {
                    // ğŸ”š ì„¸ì…˜ ì¢…ë£Œ â†’ ìš”ì•½ ìš”ì²­
                    document.getElementById("questionText").textContent = "(ì§ˆë¬¸ ì¢…ë£Œ)";
                    btn.textContent = "ì„¸ì…˜ ì¢…ë£Œë¨";
                    btn.disabled = true;
                    await fetchSummary();
                } else {
                    // ë‹¤ìŒ ì§ˆë¬¸ í‘œì‹œ + TTS ì¬ìƒ
                    if (data.next_question) {
                        document.getElementById("questionText").textContent = data.next_question;
                        playTTS(data.next_question);
                    }
                    // ë‹¤ì‹œ ë…¹ìŒí•  ìˆ˜ ìˆê²Œ
                    btn.textContent = "ë‹µë³€ ë…¹ìŒ ì‹œì‘";
                    btn.disabled = false;
                }

            } catch (e) {
                console.error(e);
                alert("ë‹µë³€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜: " + e);
                const btn = document.getElementById("recordBtn");
                btn.textContent = "ë‹µë³€ ë…¹ìŒ ì‹œì‘";
                btn.disabled = false;
            }
        }

        async function fetchSummary() {
            if (!sessionId) return;
            try {
                const res = await fetch("/api/v1/interview/session/summary", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!res.ok) {
                    const text = await res.text();
                    alert("ì„¸ì…˜ ìš”ì•½ ì‹¤íŒ¨: " + text);
                    return;
                }

                const data = await res.json();
                renderSummaryMarkdown(data.overall_feedback || "(ìš”ì•½ ì—†ìŒ)");
            } catch (e) {
                console.error(e);
                alert("ì„¸ì…˜ ìš”ì•½ ì¤‘ ì˜¤ë¥˜: " + e);
            }
        }
        
        function renderSummaryMarkdown(markdown) {
            if (!markdown) {
                document.getElementById("finalSummary").textContent = "(ìš”ì•½ ì—†ìŒ)";
                return;
            }

            let text = markdown
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");

            text = text.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");

            const lines = text.split(/\r?\n/);
            let html = "";
            let inList = false;

            for (let rawLine of lines) {
                const line = rawLine.trim();

                if (line.startsWith("### ")) {
                    if (inList) { html += "</ul>"; inList = false; }
                    html += `<h3>${line.substring(4)}</h3>`;
                } else if (line.startsWith("## ")) {
                    if (inList) { html += "</ul>"; inList = false; }
                    html += `<h2>${line.substring(3)}</h2>`;
                } else if (line.startsWith("# ")) {
                    if (inList) { html += "</ul>"; inList = false; }
                    html += `<h1>${line.substring(2)}</h1>`;
                } else if (line.startsWith("- ")) {
                    if (!inList) {
                        html += "<ul>";
                        inList = true;
                    }
                    html += `<li>${line.substring(2)}</li>`;
                } else if (line === "") {
                    if (inList) { html += "</ul>"; inList = false; }
                    html += "<br/>";
                } else {
                    if (inList) { html += "</ul>"; inList = false; }
                    html += `<p>${line}</p>`;
                }
            }
            if (inList) html += "</ul>";

            document.getElementById("finalSummary").innerHTML = html;
        }
    </script>
</body>
</html>
