<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>인터뷰 코칭 봇</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 24px auto;
            padding: 0 16px 32px;
            line-height: 1.5;
        }
        h1 {
            margin-bottom: 8px;
        }
        textarea {
            width: 100%;
            min-height: 80px;
        }
        .section {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #ddd;
        }
        .label {
            font-weight: 600;
        }
        #questionText {
            white-space: pre-wrap;
            background: #f8f8f8;
            padding: 8px;
            border-radius: 4px;
            margin-top: 4px;
        }
        #feedback {
            background: #f5faf8;
            padding: 12px 14px;
            border-radius: 8px;
            border: 1px solid #d4ece0;
            margin-top: 4px;
            font-size: 14px;
            line-height: 1.6;
            color: #234e38;
        }
        .feedback-list {
            margin: 0;
            padding-left: 18px;
        }
        .feedback-list li {
            margin-bottom: 4px;
        }
        button {
            padding: 8px 14px;
            margin-top: 8px;
            cursor: pointer;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .small {
            font-size: 12px;
            color: #666;
        }

        /* 종합 피드백 카드 스타일 (summary 전용) */
        #finalSummary {
            background: #fdfdfd;
            padding: 16px 18px;
            border-radius: 10px;
            border: 1px solid #e3e3e3;
            max-height: 640px;
            overflow-y: auto;
            margin-top: 8px;

            font-size: 14px;
            line-height: 1.6;
            color: #222;
        }

        #finalSummary h1,
        #finalSummary h2,
        #finalSummary h3 {
            margin: 12px 0 6px;
            line-height: 1.4;
            font-weight: 700;
        }

        #finalSummary h1 {
            font-size: 20px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 4px;
        }

        #finalSummary h2 {
            font-size: 17px;
        }

        #finalSummary h3 {
            font-size: 15px;
            color: #333;
        }

        #finalSummary ul {
            margin: 4px 0 10px 18px;
            padding-left: 0;
        }

        #finalSummary li {
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <h1>인터뷰 코칭 봇</h1>
    <p class="small">
        1) 이력서 / JD를 입력하고 세션을 시작하세요.<br>
        2) 질문이 자동으로 재생됩니다.<br>
        3) "답변 녹음 시작" → "녹음 종료" 후 인식된 텍스트를 확인/수정하고 전송하세요.<br>
        4) 인터뷰 종료 시 종합적인 피드백을 볼 수 있습니다.
    </p>

    <!-- 1. 세션 설정 -->
    <div class="section">
        <div class="label">이력서 텍스트</div>
        <textarea id="resumeText">여기에 이력서 텍스트를 넣으세요.</textarea>

        <div class="label" style="margin-top: 12px;">JD (공고 텍스트)</div>
        <textarea id="jdText">여기에 JD 텍스트를 넣으세요.</textarea>

        <div class="label" style="margin-top: 12px;">커리어 노트 (선택)</div>
        <textarea id="careerNote" placeholder="선택사항"></textarea>

        <button id="startBtn" onclick="startSession()">세션 시작</button>
    </div>

    <!-- 2. 질문 / TTS 재생 -->
    <div class="section">
        <div class="label">현재 질문</div>
        <div id="questionText">-</div>

        <audio id="questionAudio" controls autoplay style="margin-top: 8px; width: 100%;"></audio>
    </div>

    <!-- 3. 답변 녹음 / STT / 피드백 -->
    <div class="section">
        <div class="label">답변 녹음</div>
        <button id="recordBtn" onclick="toggleRecording()" disabled>답변 녹음 시작</button>
        <div class="small">
            * 첫 클릭: 마이크 권한 요청 후 녹음 시작<br>
            * 두 번째 클릭: 녹음 종료 → 인식된 답변 확인 & 수정 후 전송
        </div>

        <div class="label" style="margin-top: 12px;">인식된 답변 (수정 가능)</div>
        <textarea id="recognizedAnswerInput" placeholder="여기에 음성 인식 결과가 표시됩니다. 필요하면 수정하세요." style="width: 100%; min-height: 80px;"></textarea>

        <button id="sendTextBtn" onclick="sendTextAnswer()" disabled>답변 전송</button>

        <div class="label" style="margin-top: 12px;">현재 질문/답변에 대한 피드백</div>
        <div id="feedback">-</div>
    </div>

    <!-- 4. 최종 요약 -->
    <div class="section">
        <div class="label">인터뷰 종합 피드백</div>
        <div id="finalSummary">-</div>
    </div>

    <script>
        let sessionId = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        async function startSession() {
            const resumeText = document.getElementById("resumeText").value;
            const jdText = document.getElementById("jdText").value;
            const careerNote = document.getElementById("careerNote").value || null;

            const startBtn = document.getElementById("startBtn");
            startBtn.disabled = true;
            startBtn.textContent = "세션 생성 중...";

            try {
                const res = await fetch("/api/v1/interview/session/init", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        resume_text: resumeText,
                        job_description: jdText,
                        career_note: careerNote,
                        mode: "mock"
                    })
                });

                if (!res.ok) {
                    const text = await res.text();
                    alert("세션 생성 실패: " + text);
                    startBtn.disabled = false;
                    startBtn.textContent = "세션 시작";
                    return;
                }

                const data = await res.json();

                sessionId = data.session_id;
                document.getElementById("questionText").textContent = data.question;

                // 첫 질문 TTS 자동 재생
                playTTS(data.question);

                // 녹음 버튼 활성화 및 초기화
                document.getElementById("recordBtn").disabled = false;
                document.getElementById("recordBtn").textContent = "답변 녹음 시작";
                document.getElementById("feedback").textContent = "-";
                document.getElementById("recognizedAnswerInput").value = "";
                document.getElementById("finalSummary").textContent = "-";

            } catch (e) {
                console.error(e);
                alert("세션 생성 중 오류: " + e);
                startBtn.disabled = false;
                startBtn.textContent = "세션 시작";
            }
        }

        function playTTS(text) {
            if (!text) return;
            const audio = document.getElementById("questionAudio");
            const url = "/tts/stream?text=" + encodeURIComponent(text);
            audio.src = url;
            audio.play().catch(err => {
                console.warn("자동 재생 실패 (브라우저 정책일 수 있음):", err);
            });
        }

        async function toggleRecording() {
            if (!sessionId) {
                alert("세션이 없습니다. 먼저 세션을 시작하세요.");
                return;
            }

            const btn = document.getElementById("recordBtn");

            if (!isRecording) {
                // 녹음 시작
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = async () => {
                        const blob = new Blob(audioChunks, { type: "audio/webm" });
                        await sendTranscription(blob);
                        // 스트림 정리
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    btn.textContent = "녹음 종료 (음성 답변 인식 실행)";
                } catch (e) {
                    console.error("마이크 권한 오류:", e);
                    alert("마이크 권한을 허용해야 녹음할 수 있습니다.");
                }
            } else {
                // 녹음 중지 → onstop에서 STT 호출
                mediaRecorder.stop();
                isRecording = false;
                btn.textContent = "답변 인식 중...";
                btn.disabled = true;
            }
        }

        async function sendTranscription(blob) {
            if (!sessionId) return;

            const recordBtn = document.getElementById("recordBtn");
            const sendTextBtn = document.getElementById("sendTextBtn");
            const input = document.getElementById("recognizedAnswerInput");

            try {
                const fd = new FormData();
                fd.append("session_id", sessionId);
                fd.append("audio_file", blob, "answer.webm");

                const res = await fetch("/api/v1/interview/session/transcribe", {
                    method: "POST",
                    body: fd
                });

                if (!res.ok) {
                    const text = await res.text();
                    alert("음성 인식 실패: " + text);
                    recordBtn.textContent = "답변 녹음 시작";
                    recordBtn.disabled = false;
                    return;
                }

                const data = await res.json();
                input.value = data.recognized_answer || "";
                if (!input.value) {
                    input.placeholder = "음성에서 내용을 인식하지 못했습니다. 직접 입력해 주세요.";
                }

                // 이제 텍스트를 확인/수정하고 보내도록
                sendTextBtn.disabled = false;
                recordBtn.textContent = "답변 녹음 다시 하기";
                recordBtn.disabled = false;

            } catch (e) {
                console.error(e);
                alert("음성 인식 중 오류: " + e);
                recordBtn.textContent = "답변 녹음 시작";
                recordBtn.disabled = false;
            }
        }

        async function sendTextAnswer() {
            if (!sessionId) {
                alert("세션이 없습니다. 먼저 세션을 시작하세요.");
                return;
            }

            const input = document.getElementById("recognizedAnswerInput");
            const answerText = input.value.trim();
            const sendTextBtn = document.getElementById("sendTextBtn");
            const recordBtn = document.getElementById("recordBtn");

            if (!answerText) {
                alert("답변 텍스트가 비어 있습니다.");
                return;
            }

            sendTextBtn.disabled = true;
            sendTextBtn.textContent = "답변 전송 중...";

            try {
                const res = await fetch("/api/v1/interview/session/answer", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        session_id: sessionId,
                        answer: answerText
                    })
                });

                if (!res.ok) {
                    const text = await res.text();
                    alert("답변 전송 실패: " + text);
                    sendTextBtn.textContent = "이 텍스트로 답변 전송";
                    sendTextBtn.disabled = false;
                    return;
                }

                const data = await res.json();

                // 피드백 표시
                document.getElementById("feedback").textContent =
                    data.feedback || "(피드백 없음)";

                if (data.finished) {
                    document.getElementById("questionText").textContent = "(질문 종료)";
                    recordBtn.textContent = "세션 종료됨";
                    recordBtn.disabled = true;
                    await fetchSummary();
                } else {
                    // 다음 질문 + TTS
                    if (data.next_question) {
                        document.getElementById("questionText").textContent = data.next_question;
                        playTTS(data.next_question);
                    }
                    // 다음 답변을 위해 입력창 초기화
                    input.value = "";
                    input.placeholder = "다음 답변을 녹음하거나 직접 입력해 주세요.";
                    sendTextBtn.textContent = "이 텍스트로 답변 전송";
                    sendTextBtn.disabled = true;  // 다음 녹음/입력 전까지 비활성화
                    recordBtn.textContent = "답변 녹음 시작";
                    recordBtn.disabled = false;
                }

            } catch (e) {
                console.error(e);
                alert("답변 전송 중 오류: " + e);
                sendTextBtn.textContent = "이 텍스트로 답변 전송";
                sendTextBtn.disabled = false;
            }
        }

        async function fetchSummary() {
            if (!sessionId) return;
            try {
                const res = await fetch("/api/v1/interview/session/summary", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!res.ok) {
                    const text = await res.text();
                    alert("세션 요약 실패: " + text);
                    return;
                }

                const data = await res.json();
                renderSummaryMarkdown(data.overall_feedback || "(요약 없음)");
            } catch (e) {
                console.error(e);
                alert("세션 요약 중 오류: " + e);
            }
        }
        
        function renderSummaryMarkdown(markdown) {
            if (!markdown) {
                document.getElementById("finalSummary").textContent = "(요약 없음)";
                return;
            }

            let text = markdown
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");

            text = text.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");

            const lines = text.split(/\r?\n/);
            let html = "";
            let inList = false;

            for (let rawLine of lines) {
                const line = rawLine.trim();

                if (line.startsWith("### ")) {
                    if (inList) { html += "</ul>"; inList = false; }
                    html += `<h3>${line.substring(4)}</h3>`;
                } else if (line.startsWith("## ")) {
                    if (inList) { html += "</ul>"; inList = false; }
                    html += `<h2>${line.substring(3)}</h2>`;
                } else if (line.startsWith("# ")) {
                    if (inList) { html += "</ul>"; inList = false; }
                    html += `<h1>${line.substring(2)}</h1>`;
                } else if (line.startsWith("- ")) {
                    if (!inList) {
                        html += "<ul>";
                        inList = true;
                    }
                    html += `<li>${line.substring(2)}</li>`;
                } else if (line === "") {
                    if (inList) { html += "</ul>"; inList = false; }
                    html += "<br/>";
                } else {
                    if (inList) { html += "</ul>"; inList = false; }
                    html += `<p>${line}</p>`;
                }
            }
            if (inList) html += "</ul>";

            document.getElementById("finalSummary").innerHTML = html;
        }
    </script>
</body>
</html>
